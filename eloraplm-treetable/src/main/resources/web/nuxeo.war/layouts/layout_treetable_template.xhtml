<f:subview
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:c="http://java.sun.com/jstl/core"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:a4j="http://richfaces.org/a4j"
  xmlns:nxl="http://nuxeo.org/nxforms/layout"
  xmlns:nxu="http://nuxeo.org/nxweb/util"
  xmlns:nxr="http://nuxeo.org/nxweb/resources"
  xmlns:p="http://primefaces.org/ui"
  id="#{layout.id}">

    <h:outputStylesheet src="/css/elora-treetable.css" target="head" />

    <nxu:set var="treeWidgetId" value="#{widget.id}">
    <nxu:set var="treeLayoutId" value="#{layout.id}">

    <h:form id="treetableForm">
    
    <nxu:set var="rowStyleClass" value="#{layout.properties.isEditable ?
        (nodeData.isNew ? 'rowIsNew' : (nodeData.isRemoved ? 'rowIsRemoved' : (nodeData.isModified ? 'rowIsModified' : 'rowIsNormal')))
        : ''}" >
    
        <p:treeTable id="#{treeWidgetId}" widgetVar="treetbl" value="#{value.root}"
            var="nodeData" nodeVar="node" 
            resizableColumns="true" tableStyleClass="treetable"
            tableStyle="#{layout.properties.tableStyle}"
            rowStyleClass="#{rowStyleClass}"
            emptyMessage="#{messages['eloraplm.message.info.treetable.noRecordsFound']}"
            >
            
            <c:if test="#{layout.properties.isSortable}">
                <f:attribute name="sortBy" value="#{nodeData[layout.properties.sortBy]}" />
                <f:attribute name="sortOrder" value="#{layout.properties.sortOrder}" />
            </c:if>
            
            <f:facet name="header" style="overflow: hidden;">
            
                <!-- This is the only place where we can put the a4j:status in order to work when the PrimeFaces response is returned -->
                <a4j:status>
                    <f:facet name="start">
                        <h:graphicImage value="/img/standart_waiter.gif" />
                    </f:facet>
                </a4j:status>
                
                <h:panelGroup styleClass="treeHeaderTitle">
                    <h:outputText value="#{messages[layout.properties.tableTitle]}"/>
                </h:panelGroup>
                
                <h:panelGroup styleClass="treeHeaderButtons">
                    <h:panelGroup styleClass="headerFilters" rendered="#{not empty layout.properties.headerFiltersTemplate}">
                        <ui:include src="#{layout.properties.headerFiltersTemplate}" />
                    </h:panelGroup>
                
                    <a4j:commandButton
                        actionListener="#{value.collapseAll}"
                        render="#{treeWidgetId}"
                        execute="@this"
                        image="/icons/fold.png"
                        styleClass="button"
                        style="width: 48px; height: 24px;"
                        title="#{messages['eloraplm.command.treetable.collapseAll']}"
                    />
                    
                    <a4j:commandButton
                        actionListener="#{value.expandAll}"
                        render="#{treeWidgetId}"
                        execute="@this"
                        image="/icons/unfold.png"
                        styleClass="button"
                        style="width: 48px; height: 24px;"
                        title="#{messages['eloraplm.command.treetable.expandAll']}"
                    />
                    
                    <a4j:commandButton
                        actionListener="#{value.reloadTree}"
                        render="#{treeWidgetId}"
                        execute="@this"
                        image="/icons/refresh.png"
                        styleClass="button"
                        style="width: 42px; height: 16px;"
                        title="#{messages['eloraplm.command.treetable.reload']}"
                    />
                    
                </h:panelGroup>
                
            </f:facet>
            
            <nxl:layoutColumn>
                <p:column style="#{layoutColumn.properties.columnStyle}" styleClass="treetableColumn #{layoutColumn.properties.columnStyleClass}"
                        headerText="#{messages[layoutColumn.properties.columnHeading]}">
                    <nxl:layoutColumnWidget>
                        <nxl:widget widget="#{widget}" mode="view" value="#{nodeData}" />
                    </nxl:layoutColumnWidget>
                </p:column>
            </nxl:layoutColumn>
            
        </p:treeTable>

    </nxu:set>
    
    </h:form>
        
    <h:panelGroup id="treetableButtonsPanel" styleClass="treetableButtonsPanel"
        layout="block" style="text-align: right; margin: 10px 0;"
        rendered="#{layout.properties.showButtons}">
        
        <!-- If the current document is a proxy, get its source -->
        <nxu:set var="nonProxyDocument" value="#{currentDocument.isProxy() ? documentManager.getSourceDocument(currentDocument.ref) : currentDocument}">
            <nxl:widget name="treetableButtons" mode="view" value="#{nonProxyDocument}" />
        </nxu:set>
        
    </h:panelGroup>
    
    </nxu:set>
    </nxu:set>
    
</f:subview>